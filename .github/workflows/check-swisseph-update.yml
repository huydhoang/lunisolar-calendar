name: Check Swiss Ephemeris Updates

# Run weekly on Monday at 06:00 UTC, and allow manual dispatch.
on:
  schedule:
    - cron: '0 6 * * 1'
  workflow_dispatch:

jobs:
  check-update:
    name: Check for new Swiss Ephemeris release
    runs-on: ubuntu-latest
    permissions:
      issues: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check for upstream updates
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Our vendored version
          VENDORED=$(grep '#define SE_VERSION' vendor/swisseph/sweph.h | sed 's/.*"\(.*\)".*/\1/')
          echo "Vendored SE version: $VENDORED"

          # Latest tag from official repo
          LATEST=$(curl -sSL "https://api.github.com/repos/aloistr/swisseph/tags?per_page=1" | \
            python3 -c "import sys,json; print(json.load(sys.stdin)[0]['name'])" 2>/dev/null || echo "unknown")
          echo "Latest upstream tag: $LATEST"

          # Strip leading 'v' for comparison
          LATEST_CLEAN="${LATEST#v}"

          if [ "$VENDORED" = "$LATEST_CLEAN" ]; then
            echo "âœ… Swiss Ephemeris is up to date ($VENDORED)"
          else
            echo "âš ï¸ New Swiss Ephemeris version available: $LATEST_CLEAN (vendored: $VENDORED)"

            # Check if an issue already exists
            EXISTING=$(gh issue list --label "dependencies" --search "Swiss Ephemeris $LATEST_CLEAN" --state open --json number --jq length 2>/dev/null || echo "0")
            if [ "$EXISTING" = "0" ]; then
              gh issue create \
                --title "Update vendored Swiss Ephemeris to $LATEST" \
                --label "dependencies" \
                --body "A new Swiss Ephemeris version is available.

          **Current vendored version:** \`$VENDORED\`
          **Latest upstream version:** \`$LATEST\`
          **Source:** [aloistr/swisseph](https://github.com/aloistr/swisseph/releases/tag/$LATEST)

          ### Steps to update
          1. Download the 9 core C files + headers from the [$LATEST tag](https://github.com/aloistr/swisseph/tree/$LATEST)
          2. Replace files in \`vendor/swisseph/\`
          3. Run \`wasm-pack build --target nodejs --release\` in \`ports/swisseph-rs/\`
          4. Run the benchmark: \`node tests/swisseph-wasm/benchmark.mjs\`
          5. Verify position agreement is still < 0.001Â°"
              echo "ðŸ“‹ Created issue for Swiss Ephemeris update"
            else
              echo "ðŸ“‹ Issue already exists for this version"
            fi
          fi
